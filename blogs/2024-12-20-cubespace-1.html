<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="initial-scale=1.0, width=device-width" data-next-head=""/><title data-next-head="">CubeScape를 R3F로 만들어 보기</title><link rel="preload" href="/_next/static/css/d20c50ed748cd26f.css" as="style"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/vs2015.min.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous"/><link rel="stylesheet" href="/_next/static/css/d20c50ed748cd26f.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-0b9df2340104f8e1.js" defer=""></script><script src="/_next/static/chunks/framework-80cff53c93df8ff7.js" defer=""></script><script src="/_next/static/chunks/main-beade485850481f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5b36dff9503cb490.js" defer=""></script><script src="/_next/static/chunks/4559568c-12227db92eb58414.js" defer=""></script><script src="/_next/static/chunks/69b51223-4704b4208ae9fa3b.js" defer=""></script><script src="/_next/static/chunks/ccf9b928-7fee4934ff5f3eec.js" defer=""></script><script src="/_next/static/chunks/5695-9c01eff236121af5.js" defer=""></script><script src="/_next/static/chunks/5302-4de31203f4eefce9.js" defer=""></script><script src="/_next/static/chunks/2077-04b4c70c93fb610a.js" defer=""></script><script src="/_next/static/chunks/3855-f5226ac91d8e51b5.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/2024-12-20-cubespace-1-0e2f075a54ddfcf9.js" defer=""></script><script src="/_next/static/qfjDRDkI7hbaUN0YCN0K0/_buildManifest.js" defer=""></script><script src="/_next/static/qfjDRDkI7hbaUN0YCN0K0/_ssgManifest.js" defer=""></script><style id="__jsx-4134105190">.markdown html{font:118.75%/1.58 'Roboto',serif;box-sizing:border-box;overflow-y:scroll;}.markdown *{box-sizing:inherit;}.markdown *:before{box-sizing:inherit;}.markdown *:after{box-sizing:inherit;}.markdown body{color:hsla(0,0%,0%,0.73);font-family:'Roboto',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}.markdown img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}.markdown h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}.markdown h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}.markdown h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}.markdown h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}.markdown h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}.markdown hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown ul{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}.markdown ol{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}.markdown dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.85rem;line-height:1.58rem;}.markdown table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:1rem;line-height:1.58rem;border-collapse:collapse;width:100%;}.markdown fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.94737rem;line-height:1.58rem;border-left:0.5925rem solid #017698;color:hsla(0,0%,0%,0.65);background-color:hsla(0,0%,0%,0.1);padding:0.29625rem 0.9875rem;font-style:italic;}.markdown form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.58rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}.markdown address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown b{font-weight:700;}.markdown strong{font-weight:700;}.markdown dt{font-weight:700;}.markdown th{font-weight:700;}.markdown li{margin-bottom:calc(1.58rem / 2);}.markdown ol li{padding-left:0;}.markdown ul li{padding-left:0;}.markdown li > ol{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}.markdown li > ul{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}.markdown blockquote *:last-child{margin-bottom:0;}.markdown li *:last-child{margin-bottom:0;}.markdown p *:last-child{margin-bottom:0;}.markdown li > p{margin-bottom:calc(1.58rem / 2);}.markdown code{font-size:0.85rem;line-height:1.58rem;}.markdown kbd{font-size:0.85rem;line-height:1.58rem;}.markdown samp{font-size:0.85rem;line-height:1.58rem;}.markdown abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}.markdown acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}.markdown abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}.markdown thead{text-align:left;}.markdown td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.05333rem;padding-right:1.05333rem;padding-top:0.79rem;padding-bottom:calc(0.79rem - 1px);}.markdown th:first-child,td:first-child{padding-left:0;}.markdown th:last-child,td:last-child{padding-right:0;}.markdown a{color:#017698;text-decoration:none;background-image:linear-gradient(to top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0) 1px, #017698 1px, #017698 2px, rgba(0, 0, 0, 0) 2px);}.markdown a:hover,a:active{text-shadow:none;background-image:none;}.markdown h1,h2,h3,h4,h5,h6{margin-top:3.16rem;}.markdown li>ol,li>ul{margin-left:20px;margin-bottom:0;}.markdown blockquote > :last-child{margin-bottom:0;}.markdown blockquote cite{font-size:1rem;line-height:1.58rem;color:hsla(0,0%,0%,0.73);font-style:normal;font-weight:400;}.markdown blockquote cite:before{content:"— ";}.markdown @media only screen and (max-width:480px){html{font-size:106.25%;line-height:28px;}blockquote{border-left:0.29625rem solid #017698;color:hsla(0,0%,0%,0.59);padding-left:0.88875rem;font-style:italic;margin-left:-1.185rem;margin-right:0;}} .markdown{color:#3d3d3d}.markdown ul li{list-style-type:disc}.markdown ol{list-style-type:decimal}:not(pre) code{background-color:rgb(203 208 218);border-radius:3px;font-family:D2Coding,Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:.2rem .3rem;margin:0 .2rem}.markdown * code{font-size:inherit}.markdown code[class*="language-"]{font-family:D2Coding,Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:1rem;background-color:#2d2d2d}</style></head><body><div id="__next"><div class="leading-normal tracking-normal bg-gray-100 min-h-screen"><nav class="w-full"><div id="progress" class="top-0 z-20 h-1" style="background:linear-gradient(to right, #4dc0b5 var(--scroll), transparent 0)"></div><div class="flex flex-wrap items-center justify-between w-full py-3 mx-auto mt-0 md:max-w-4xl"><div class="pl-4"><a class="text-xl font-extrabold text-gray-900 no-underline hover:no-underline" href="/">lifetime trails</a></div><div class="block pr-4 lg:hidden"><button id="nav-toggle" type="button" class="flex items-center px-3 py-2 text-gray-500 appearance-none hover:text-gray-900 hover:border-teal-500 focus:outline-none"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button></div><div id="nav-content" class="bg-gray-100 border-b flex-grow lg:border-none lg:flex lg:items-center lg:mt-0 lg:shadow-none lg:w-auto md:bg-transparent mt-2 shadow w-full z-20 hidden"><ul class="items-center justify-end flex-1 list-reset lg:flex"><li class="mr-3"><a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:text-underline py-2 px-4" href="/">Home</a></li></ul></div></div></nav><div class="container w-full px-4 pb-10 mx-auto md:max-w-3xl"><h1 class="font-bold text-gray-800 mb-4 text-5xl mt-8 mb-8">CubeScape를 R3F로 만들어 보기</h1><div class="details"><p class="text-gray-500">three.js journey에 halloween 챌린지 우승작인 CubeSpace 게임을 분석해보고 R3F로 만들어 봅니다.</p><p class="text-gray-400 text-right -mt-1"><span class="mr-4">2024-12-20</span></p></div><article class="markdown"><h1>소개</h1>
<p><a href="https://threejs-journey.com/">Three.js Journey — Learn WebGL with Three.js</a>라는 유료 튜토리얼 사이트에서 할로윈 챌린지를 했습니다.</p>
<p><a href="https://threejs-journey.com/challenges/014-halloween-2">Halloween 2 Challenge — Three.js Journey</a></p>
<p>이중 우승작인 <a href="https://cubescape.andriibabintsev.com/">CubeScape</a>는 간단하지만 완성도 높은 게임을 선보였습니다.</p>
<p>고맙게도 소스코드(<a href="https://github.com/Snokke/cubescape">Snokke/cubescape: CubeScape Game</a>)를 오픈하여 완성도 높은 게임의 구현체를 옅볼 수 있었습니다.</p>
<p>그간 three.js에 대해서는 기능과 API 정도를 익혀 왔는데요.
완성도 높은 결과물을 만들어 내기에는 경험과 품이 많이 든다고 생각이 들었습니다.
특히나 react의 선언적인 프로그래밍 방식에 익숙해지다 보니 three.js의 API 구성이 다소 올드하게 느껴져 흥미도 떨어졌습니다.</p>
<p>그러다 R3F를 발견하고 다시 관심있게 3d 프로그래밍을 틈틈히 익혀 보고 있었는데요.
완성도 높은 게임의 소스 코드를 발견한 이상 이를 r3f로 포팅하고 싶은 호기심이 생겼습니다.</p>
<h1>CubeScape</h1>
<p>이 게임은 맵을 돌아다니면서 코인을 먹고, 탈출구를 찾는 게임인데요.
Cube라는 정사각형 표면 위에 미로를 구성하고 6면체를 회전해 가면서 탈출구를 찾는 방식이 매우 흥미로웠습니다.</p>
<h2>기술 스텍</h2>
<p>three.js와 pixi.js를 사용하여 3d와 2d 렌더링을 합니다.</p>
<p>type safe한 event emitter를 위해 <code>mitt</code>라는 패키지를 사용하였습니다.</p>
<p>vite로 번들링합니다.</p>
<h2>디렉터리 구조</h2>
<p>완성도 높은 게임 답게 꼼꼼한 컨벤션과 코드 품질을 가지고 있었는데요.</p>
<p><code>src/core</code> 디렉터리는 asset loader 등 게임 독립적인 라이브러리를 구현하였습니다.</p>
<p><code>src/UI</code> 디렉터리는 2D 사용자 인터페이스를 구현하였습니다.</p>
<p><code>src/scene</code> 디렉터리는 실제 계임 관련 코드가 있습니다.
<code>Enums</code>, <code>Interfaces</code>는 타입 정의를 <code>Configs</code>는 다양한 magic number를 포함하고 있습니다.
<code>GameScene</code>, <code>Helpers</code>는 <code>Configs</code>의 설정값들을 기반으로 게임 화면과 플레이 방식을 구성합니다.</p>
<p>아쉬운 것은 소프트웨어 기능별로 파일 구분을 하지 않고 언어적인 형식 별로 디렉터리가 나우어져 있는 점 입니다.
각 기능별로 enum, interface, config 및 asset과 실제 렌더링 및 게임 로직을 같은 디렉터리에 구성을 했다면 분석하는데 조금 수월했지 않을까란 생각입니다.</p>
<p><code>GameScene</code>이 중심이되어 cube, player, enemy, coin, light 등을 생성하고 연결합니다.</p>
<h2>R3F 포팅 전략</h2>
<p>게임 로직에 앞서 3d 객체의 구성을 해보았습니다.</p>
<div style="width:100%;height:400px"><div style="width:100%;height:100%"><div><div style="position:relative;width:0;height:0;overflow:hidden;pointer-events:auto;border:1px solid black"><div style="width:100%;height:100%"><canvas style="display:block"></canvas></div></div></div></div></div>
<p><code>THREE.Group</code>을 확장하는 3d rendering tree에 속하는 객체를 React 컴포넌트로 구성합니다.</p>
<p>모서리를 표현하는 <code>Edge</code> 컴포넌트를 살펴 봅니다.</p>
<pre><code class="language-tsx">import * as THREE from &#x27;three&#x27;;
import * as React from &#x27;react&#x27;;
import MainMaterial from &#x27;../Materials/MainMaterial&#x27;;
import { useInstancedMesh, useModelGeometry } from &#x27;../../../core/hooks&#x27;;

export type Props = {
  asset: string;
  edgeCells: THREE.Object3D&lt;THREE.Object3DEventMap&gt;[];
};

function Edge(props: Props) {
  const { asset, edgeCells } = props;
  const geometry = useModelGeometry(asset);
  const ref = useInstancedMesh(edgeCells);
  // console.log(&#x27;Edge&#x27;, { edgeCells, geometry });
  return (
    &lt;instancedMesh ref={ref} args={[geometry, undefined, edgeCells.length]} receiveShadow castShadow&gt;
      &lt;MainMaterial /&gt;
    &lt;/instancedMesh&gt;
  );
}

export default React.memo(Edge);
</code></pre>
<p><code>asset</code>으로 <code>glb</code> 파일의 경로를 전달하면 <code>useModelGeometry</code> 훅을 사용하여 glb 파일로 부터 geometry 정보를 얻어옵니다.
원본 코드는 필요한 어셋이나 텍스쳐 이미지를 미리 로딩하지만 React는 suspense 기능등이 있기 때문세 사용하는 곳에서 선언작으로 asset 파일을 로딩할 수 있도록 하였습니다.</p>
<p><code>useInstancedMesh</code>는 <code>THREE.InstanceMesh</code>의 초기화를 도와 줍니다.
<code>THREE.InstanceMesh</code>는 하나의 mesh 정보만 사용하여 여러개의 인스턴스를 생성해 줍니다.</p>
<p>다음 예제는 정사각형을 geometry로하는 <code>instancedMesh</code>를 사용하여 많은양의 각기 다른 인스턴스를 생성 및 제어하는 모습을 보여 줍니다.</p>
<div style="position:relative;width:100%;height:100%;overflow:hidden;pointer-events:auto"><div style="width:100%;height:100%"><canvas style="display:block"></canvas></div></div>
<p>이렇게 게임에서는 <code>instanceMesh</code>를 사용해서 동일한 모델을 여러위치에 배치할 수 있습니다.</p>
<p><code>Configs</code>에 있는 magic number 대신에 컴포넌트의 attribute로 직접 전달하도록 합니다.</p>
<pre><code class="language-tsx">function Edges(props: Props) {
  const { levelMap } = props;

  /// 생략

  // console.log(&#x27;Edges&#x27;, { edgeCellsByProbability });
  return (
    &lt;&gt;
      &lt;Edge asset={glbEdge01} edgeCells={edgeCellsByProbability[0]} /&gt;
      &lt;Edge asset={glbEdge02} edgeCells={edgeCellsByProbability[1]} /&gt;
      &lt;Edge asset={glbEdge03} edgeCells={edgeCellsByProbability[2]} /&gt;
      &lt;Edge asset={glbEdge04} edgeCells={edgeCellsByProbability[3]} /&gt;
    &lt;/&gt;
  );
}
</code></pre>
<h1>마치며</h1>
<p>Three.js만을 사용하여 구현한 CubeSpace를 R3F를 사용하여 표현해 보았습니다.
순차적이고 imperative한 three.js 코딩 방식에서 react 기반의 declarative하고 상태 지향적인 코딩 방식으로 변환해 보았습니다.</p>
<p>개인적으로는 후자의 방식이 구조를 조금더 명확히 드러내고, 로직을 분산하는 객체지향 보다는 상대적으로 react의 hook 방식이 aspect 지향적인 프로그램을 하기가 조금더 용이하다고 생각합니다.</p>
<p>따라서 이러한 변환 과정을 통해서 어려움도 있었지만 좋은 경험을 하게 되었습니다.</p>
<p>다음에 여유가 된다면 실제 게임로직을 react 스럽게 포팅해 보려 합니다.</p>
<p>3d 객체를 단순히 표한하는 것 까지는 선언적 방식이 빛을 발하는데, 게임과 같이 이벤트를 받아 상태에 따라 처리하는 로직에 적합할지는 두고봐야 겠습니다.</p></article><div class="react-utterences"><div>Loading script...</div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blogs/2024-12-20-cubespace-1","query":{},"buildId":"qfjDRDkI7hbaUN0YCN0K0","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>