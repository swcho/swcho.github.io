<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="initial-scale=1.0, width=device-width" data-next-head=""/><title data-next-head="">Temporal Execution Platform 리뷰 #2</title><link rel="preload" href="/_next/static/css/d20c50ed748cd26f.css" as="style"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/vs2015.min.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous"/><link rel="stylesheet" href="/_next/static/css/d20c50ed748cd26f.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-0b9df2340104f8e1.js" defer=""></script><script src="/_next/static/chunks/framework-80cff53c93df8ff7.js" defer=""></script><script src="/_next/static/chunks/main-beade485850481f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5b36dff9503cb490.js" defer=""></script><script src="/_next/static/chunks/5695-9c01eff236121af5.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/2023-12-25-temporal-2-dc82731205c5f174.js" defer=""></script><script src="/_next/static/qfjDRDkI7hbaUN0YCN0K0/_buildManifest.js" defer=""></script><script src="/_next/static/qfjDRDkI7hbaUN0YCN0K0/_ssgManifest.js" defer=""></script><style id="__jsx-4134105190">.markdown html{font:118.75%/1.58 'Roboto',serif;box-sizing:border-box;overflow-y:scroll;}.markdown *{box-sizing:inherit;}.markdown *:before{box-sizing:inherit;}.markdown *:after{box-sizing:inherit;}.markdown body{color:hsla(0,0%,0%,0.73);font-family:'Roboto',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}.markdown img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}.markdown h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}.markdown h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}.markdown h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}.markdown h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}.markdown h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}.markdown hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown ul{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}.markdown ol{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}.markdown dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.85rem;line-height:1.58rem;}.markdown table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:1rem;line-height:1.58rem;border-collapse:collapse;width:100%;}.markdown fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.94737rem;line-height:1.58rem;border-left:0.5925rem solid #017698;color:hsla(0,0%,0%,0.65);background-color:hsla(0,0%,0%,0.1);padding:0.29625rem 0.9875rem;font-style:italic;}.markdown form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.58rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}.markdown address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown b{font-weight:700;}.markdown strong{font-weight:700;}.markdown dt{font-weight:700;}.markdown th{font-weight:700;}.markdown li{margin-bottom:calc(1.58rem / 2);}.markdown ol li{padding-left:0;}.markdown ul li{padding-left:0;}.markdown li > ol{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}.markdown li > ul{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}.markdown blockquote *:last-child{margin-bottom:0;}.markdown li *:last-child{margin-bottom:0;}.markdown p *:last-child{margin-bottom:0;}.markdown li > p{margin-bottom:calc(1.58rem / 2);}.markdown code{font-size:0.85rem;line-height:1.58rem;}.markdown kbd{font-size:0.85rem;line-height:1.58rem;}.markdown samp{font-size:0.85rem;line-height:1.58rem;}.markdown abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}.markdown acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}.markdown abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}.markdown thead{text-align:left;}.markdown td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.05333rem;padding-right:1.05333rem;padding-top:0.79rem;padding-bottom:calc(0.79rem - 1px);}.markdown th:first-child,td:first-child{padding-left:0;}.markdown th:last-child,td:last-child{padding-right:0;}.markdown a{color:#017698;text-decoration:none;background-image:linear-gradient(to top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0) 1px, #017698 1px, #017698 2px, rgba(0, 0, 0, 0) 2px);}.markdown a:hover,a:active{text-shadow:none;background-image:none;}.markdown h1,h2,h3,h4,h5,h6{margin-top:3.16rem;}.markdown li>ol,li>ul{margin-left:20px;margin-bottom:0;}.markdown blockquote > :last-child{margin-bottom:0;}.markdown blockquote cite{font-size:1rem;line-height:1.58rem;color:hsla(0,0%,0%,0.73);font-style:normal;font-weight:400;}.markdown blockquote cite:before{content:"— ";}.markdown @media only screen and (max-width:480px){html{font-size:106.25%;line-height:28px;}blockquote{border-left:0.29625rem solid #017698;color:hsla(0,0%,0%,0.59);padding-left:0.88875rem;font-style:italic;margin-left:-1.185rem;margin-right:0;}} .markdown{color:#3d3d3d}.markdown ul li{list-style-type:disc}.markdown ol{list-style-type:decimal}:not(pre) code{background-color:rgb(203 208 218);border-radius:3px;font-family:D2Coding,Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:.2rem .3rem;margin:0 .2rem}.markdown * code{font-size:inherit}.markdown code[class*="language-"]{font-family:D2Coding,Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:1rem;background-color:#2d2d2d}</style></head><body><div id="__next"><div class="leading-normal tracking-normal bg-gray-100 min-h-screen"><nav class="w-full"><div id="progress" class="top-0 z-20 h-1" style="background:linear-gradient(to right, #4dc0b5 var(--scroll), transparent 0)"></div><div class="flex flex-wrap items-center justify-between w-full py-3 mx-auto mt-0 md:max-w-4xl"><div class="pl-4"><a class="text-xl font-extrabold text-gray-900 no-underline hover:no-underline" href="/">lifetime trails</a></div><div class="block pr-4 lg:hidden"><button id="nav-toggle" type="button" class="flex items-center px-3 py-2 text-gray-500 appearance-none hover:text-gray-900 hover:border-teal-500 focus:outline-none"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button></div><div id="nav-content" class="bg-gray-100 border-b flex-grow lg:border-none lg:flex lg:items-center lg:mt-0 lg:shadow-none lg:w-auto md:bg-transparent mt-2 shadow w-full z-20 hidden"><ul class="items-center justify-end flex-1 list-reset lg:flex"><li class="mr-3"><a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:text-underline py-2 px-4" href="/">Home</a></li></ul></div></div></nav><div class="container w-full px-4 pb-10 mx-auto md:max-w-3xl"><h1 class="font-bold text-gray-800 mb-4 text-5xl mt-8 mb-8">Temporal Execution Platform 리뷰 #2</h1><div class="details"><p class="text-gray-500">오픈소스 Execution 플렛폼인 Temporal에 대해 소개하고 activity 동작 방삭에 대해 살펴 봅니다.</p><p class="text-gray-400 text-right -mt-1"><span class="mr-4">2023-12-25</span></p></div><article class="markdown"><h1>Activity 동작 방식</h1>
<p>지난 시간에 이어 확인해 보고자 하는 것은 temporal workflow 함수 내에서 수행하는 activity의 동작 방식입니다.</p>
<p>Client 코드는 workflow 함수를 실행하지만 실제로는 worker의 workflow를 수행하는 것을 알 수 있었습니다.
문제는 activity 인데요, activity 하나를 수행할 때마다 client와 응답을 주고 받는지가 궁금해 졌습니다.
예상해 볼 수 있는 동작 방식은 다음과 같습니다.</p>
<ol>
<li>Client는 workflow 수행의 최종 결과만 받는다.</li>
</ol>
<ul>
<li>Client는 workflow invocation 정보만 temporal server에 전달</li>
<li>temporal server는 worker에 workflow 수행 명령</li>
<li>worker는 해당 workflow와 activity를 모두 수행 후 최종 결과를 temporal server에 전달</li>
<li>temporal server는 client에 결과 전달</li>
<li>client 종료</li>
</ul>
<ol start="2">
<li>Client는 각 activity의 응답을 받아 다음 activity 수행여부를 결정한다.</li>
</ol>
<ul>
<li>Client는 workflow invocation 정보만 temporal server에 전달</li>
<li>temporal server는 worker에 workflow 수행 명령</li>
<li>worker는 workflow 수행에 필요한 리소스 확보 후 준비되었음을 temporal server에 알림</li>
<li>temporal server는 client에 이를 전달</li>
<li>client는 activity 수행을 요청하고 결과를 받는 것을 반복</li>
<li>temporal server는 client에 결과 전달</li>
<li>client 종료</li>
</ul>
<p>분석 결과 1번 방식으로 동작하고 있었습니다.</p>
<p>따라서, client에서는 workflow invocation 정보만 전달할 뿐 실제 코드를 수행을 일체하지 않습니다.
혹여라도 client의 코드를 바꾸어도 실행중인 worker의 코드만 수행함을 알 수 있습니다.
다시 말해 client와 worker의 workflow 코드는 달라질 수 있습니다.
이 경우 어떠한 방식으로 동작하는지 알고 사용을 해야 합니다.</p>
<p>다음은 해당 결론에 이르기 까지의 분석 과정을 정리하였습니다.</p>
<h1>Concurrently 설정</h1>
<p>하나의 예제의 동작을 확인하려면, temporal server, worker, client를 순차적으로 실행해야 합니다.</p>
<p><a href="https://www.npmjs.com/package/concurrently">concurrently</a>는 동시에 여러 명령을 수행할 수 있는 개발툴 입니다.</p>
<p>concurrently를 사용하여 대략 다음과 같은 명령을 수행합니다.</p>
<pre><code class="language-shell">concurrently --names &#x27;server,worker,client&#x27; \
              -c &#x27;blue,red,green&#x27; \
              &#x27;GRPC_GO_LOG_VERBOSITY_LEVEL=99 GRPC_GO_LOG_SEVERITY_LEVEL=info temporal server start-dev&#x27; \
              &#x27;sleep 1 &amp;&amp; npm run worker&#x27; \
              &#x27;sleep 3 &amp;&amp; GRPC_VERBOSITY=DEBUG GRPC_TRACE=all npm run client&#x27;
</code></pre>
<p><code>GRPC_GO_LOG_VERBOSITY_LEVEL=99 GRPC_GO_LOG_SEVERITY_LEVEL=info temporal server start-dev</code> 명령은 개발용 temporal 서버를 로컬에서 수행합니다.
Temporal server는 go 언어로 작성한 grpc 라이브러리를 사용합니다.
<code>GRPC_GO_LOG_VERBOSITY_LEVEL=99 GRPC_GO_LOG_SEVERITY_LEVEL=info</code> 환경변수 설정은 grpc 입출력을 파악하는데 도움이 됩니다.</p>
<p>worker의 경우 rust의 GRPC 구현체인 <a href="https://github.com/hyperium/tonic">tonic</a>을 사용합니다.
<code>tonic</code> 라이브러리는 입출력을 확인할 수 있는 로깅을 제공하지 않고 있어 temporal 구현체의 로깅을 위주로 동작 파악을 해야 합니다.</p>
<p>client는 <a href="https://www.npmjs.com/package/@grpc/grpc-js">@grpc/grpc-js</a> 라이브러리를 사용하고 환경 변수인 <code>GRPC_VERBOSITY=DEBUG</code>와 <code>GRPC_TRACE=all</code>는 GRPC 송수신 로그를 출력합니다.</p>
<p>server, worker, client 각각 순차적으로 실행해야 함으로 <code>sleep</code> 명령으로 시간을 조정합니다.</p>
<p><code>names</code> 옵션은 각 shell 명령의 출력 prefix에 붙는 이름을 지정합니다.</p>
<p><code>c</code> 옵션은 각 shell 명령의 출력 prefix의 색상을 지정합니다.</p>
<p>이렇게 설정하면 다음과 같은 로그를 확인할 수 있습니다.</p>
<p><img alt="log" loading="lazy" width="1244" height="298" decoding="async" data-nimg="1" class="shadow" style="color:transparent;width:100%;height:auto" src="/_next/static/media/image.7eea5b38.png"/></p>
<p>Client는 <code>/temporal.api.workflowservice.v1.WorkflowService/StartWorkflowExecution</code> grpc 호출을 하여 workflow 수행을 server에 요청합니다.</p>
<p>곧이어 worker가 동작하고 첫번째 activity는 withdraw, deposit, moneyTransfer를 순차적으로 수행합니다.</p>
<p>Worker의 <code>moneyTransfer</code> activity를 수행하고 나면 client는 그 결과를 받아 transaction id와 같은 응답값을 표시합니다.</p>
<h1>마치며</h1>
<p>TypeScript, Rust, Go 언어를 오가며 동작을 분석하기란 쉽지 않았습니다.
내부 구조도 제법 복잡하여 protocol 단에서 데이터 송/수신 정보를 기반으로 분석해 보려 했습니다.
하지만, Go의 경우 grpc 연결 설정의 로그만 나오고 Rust의 경우 로그를 남기는 방법을 찾지 못했습니다.
다행히 node js grpc 라이브러리는 송수신 패킷 정보를 자세하게 출력하는 로그를 확인할 수 있었습니다.</p>
<p>결국 worker에서 workflow를 수행하면서 하위 activity를 모두 수행하고 그 결과를 server에 전달하는 방식임을 확인할 수 있었습니다.</p>
<p>생각보다 Temporal 분석에 시간이 많이 들고 지지 부진한 면이 있었습니다.
원래 temporal의 공식 TypeScript 예제를 분석하고 마무리하려 했으나 시간이 많이 결러 고민이 됩니다.
일단 Temporal 분석은 part 2까지 하고 다른 아이템을 찾아 리뷰해야 겠습니다.</p></article><div class="react-utterences"><div>Loading script...</div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blogs/2023-12-25-temporal-2","query":{},"buildId":"qfjDRDkI7hbaUN0YCN0K0","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>