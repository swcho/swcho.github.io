<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="initial-scale=1.0, width=device-width" data-next-head=""/><title data-next-head="">Web studio part 2</title><link rel="preload" href="/_next/static/css/d20c50ed748cd26f.css" as="style"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/vs2015.min.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous"/><link rel="stylesheet" href="/_next/static/css/d20c50ed748cd26f.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-b9bde0f71dfd7f80.js" defer=""></script><script src="/_next/static/chunks/framework-e837885f9f00810f.js" defer=""></script><script src="/_next/static/chunks/main-beade485850481f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-57b73c2138884752.js" defer=""></script><script src="/_next/static/chunks/5695-9c01eff236121af5.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/2023-09-17-webstudio-part-2-44d8e7bb072caffc.js" defer=""></script><script src="/_next/static/4VfyYs9vc-5CtkULTTuNp/_buildManifest.js" defer=""></script><script src="/_next/static/4VfyYs9vc-5CtkULTTuNp/_ssgManifest.js" defer=""></script><style id="__jsx-4134105190">.markdown html{font:118.75%/1.58 'Roboto',serif;box-sizing:border-box;overflow-y:scroll;}.markdown *{box-sizing:inherit;}.markdown *:before{box-sizing:inherit;}.markdown *:after{box-sizing:inherit;}.markdown body{color:hsla(0,0%,0%,0.73);font-family:'Roboto',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}.markdown img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}.markdown h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}.markdown h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}.markdown h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}.markdown h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}.markdown h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}.markdown hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown ul{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}.markdown ol{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}.markdown dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.85rem;line-height:1.58rem;}.markdown table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:1rem;line-height:1.58rem;border-collapse:collapse;width:100%;}.markdown fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.94737rem;line-height:1.58rem;border-left:0.5925rem solid #017698;color:hsla(0,0%,0%,0.65);background-color:hsla(0,0%,0%,0.1);padding:0.29625rem 0.9875rem;font-style:italic;}.markdown form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.58rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}.markdown address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown b{font-weight:700;}.markdown strong{font-weight:700;}.markdown dt{font-weight:700;}.markdown th{font-weight:700;}.markdown li{margin-bottom:calc(1.58rem / 2);}.markdown ol li{padding-left:0;}.markdown ul li{padding-left:0;}.markdown li > ol{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}.markdown li > ul{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}.markdown blockquote *:last-child{margin-bottom:0;}.markdown li *:last-child{margin-bottom:0;}.markdown p *:last-child{margin-bottom:0;}.markdown li > p{margin-bottom:calc(1.58rem / 2);}.markdown code{font-size:0.85rem;line-height:1.58rem;}.markdown kbd{font-size:0.85rem;line-height:1.58rem;}.markdown samp{font-size:0.85rem;line-height:1.58rem;}.markdown abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}.markdown acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}.markdown abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}.markdown thead{text-align:left;}.markdown td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.05333rem;padding-right:1.05333rem;padding-top:0.79rem;padding-bottom:calc(0.79rem - 1px);}.markdown th:first-child,td:first-child{padding-left:0;}.markdown th:last-child,td:last-child{padding-right:0;}.markdown a{color:#017698;text-decoration:none;background-image:linear-gradient(to top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0) 1px, #017698 1px, #017698 2px, rgba(0, 0, 0, 0) 2px);}.markdown a:hover,a:active{text-shadow:none;background-image:none;}.markdown h1,h2,h3,h4,h5,h6{margin-top:3.16rem;}.markdown li>ol,li>ul{margin-left:20px;margin-bottom:0;}.markdown blockquote > :last-child{margin-bottom:0;}.markdown blockquote cite{font-size:1rem;line-height:1.58rem;color:hsla(0,0%,0%,0.73);font-style:normal;font-weight:400;}.markdown blockquote cite:before{content:"— ";}.markdown @media only screen and (max-width:480px){html{font-size:106.25%;line-height:28px;}blockquote{border-left:0.29625rem solid #017698;color:hsla(0,0%,0%,0.59);padding-left:0.88875rem;font-style:italic;margin-left:-1.185rem;margin-right:0;}} .markdown{color:#3d3d3d}.markdown ul li{list-style-type:disc}.markdown ol{list-style-type:decimal}:not(pre) code{background-color:rgb(203 208 218);border-radius:3px;font-family:D2Coding,Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:.2rem .3rem;margin:0 .2rem}.markdown * code{font-size:inherit}.markdown code[class*="language-"]{font-family:D2Coding,Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:1rem;background-color:#2d2d2d}</style></head><body><div id="__next"><div class="leading-normal tracking-normal bg-gray-100 min-h-screen"><nav class="w-full"><div id="progress" class="top-0 z-20 h-1" style="background:linear-gradient(to right, #4dc0b5 var(--scroll), transparent 0)"></div><div class="flex flex-wrap items-center justify-between w-full py-3 mx-auto mt-0 md:max-w-4xl"><div class="pl-4"><a href="/">lifetime trails</a></div><div class="block pr-4 lg:hidden"><button id="nav-toggle" type="button" class="flex items-center px-3 py-2 text-gray-500 appearance-none hover:text-gray-900 hover:border-teal-500 focus:outline-none"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button></div><div id="nav-content" class="bg-gray-100 border-b flex-grow lg:border-none lg:flex lg:items-center lg:mt-0 lg:shadow-none lg:w-auto md:bg-transparent mt-2 shadow w-full z-20 hidden"><ul class="items-center justify-end flex-1 list-reset lg:flex"><li class="mr-3"><a href="/">Home</a></li></ul></div></div></nav><div class="container w-full px-4 pb-10 mx-auto md:max-w-3xl"><h1 class="font-bold text-gray-800 mb-4 text-5xl mt-8 mb-8">Web studio part 2</h1><div class="details"><p class="text-gray-500">Part 1에 이어 project 생성, 컴포넌트 구성 과정을 분석해 봅니다.</p><p class="text-gray-400 text-right -mt-1"><span class="mr-4">2023-09-10</span></p></div><article class="markdown"><h1>Tech Stack</h1>
<h2><a href="https://trpc.io/">tRPC</a></h2>
<p>TypeScript로 full stack을 개발하면 server와 client 사이의 요청의 파라미터와 응답의 형식을 TypeScript로 관리하고 싶어집니다.</p>
<p>빠른 개발 또는 잦은 요구사항 변경이 필요한 환경에서는 API 사양 변경역시 자주 발생합니다.
이때 TypeScript의 도움을 받을 수 있다면, API 파라미터나 응답의 이름 변경, 삭제, 추가에 빠르고 정확하게 대응할 수 있습니다.</p>
<p>REST, GraphQL의 경우 이러한 이점을 활용하려면 별도의 type 생성기가 필요합니다.
Type 생성기는 코드 생성을 수반하기 때문에 매끄러운 개발 환경 구성을 위한 노력이 필요합니다.</p>
<p>반면, tRPC는 server API 라우트의 형식을 <code>typeof</code> 키워드로 가져와 client를 생성하면 type checking 환경을 바로 구현할 수 있습니다.
따라서 server 코드의 작성과 동시에 client 형검사가 가능합니다.</p>
<h2><a href="https://github.com/nanostores/nanostores">nanostores/nanostores</a></h2>
<p>프레임워크에 종속적이지 않은 store 구현체 입니다.</p>
<p><code>atom</code>을 사용하여 immutable 상태를 공유하고 reactive한 처리가 가능합니다.</p>
<p><code>action</code>, <code>task</code> 등으로 store의 비동기 초기화 등이 가능합니다.</p>
<p>Micro front end 구성 시 서로 다른 프레임워크간 상태 공유가 가능한 이점이 있습니다.</p>
<h2><a href="https://github.com/webstudio-is/immerhin">webstudio-is/immerhin</a></h2>
<p><code>immer</code> 패키지의 <a href="https://immerjs.github.io/immer/patches">Patches</a> 기능을 활용하여 client, server 간 객체 상태 공유를 위한 라이브러리 입니다.</p>
<p>Web studio에서 사용하기 위해 자체 개발한 라이브러리 이며, Web studio와 관계없이 독립적인 사용이 가능합니다.</p>
<h1>프로젝트 생성</h1>
<p>Remix는 별도의 API routing 방식을 사용하지 않습니다 (<a href="https://remix.run/docs/en/main/guides/api-routes">API Routes | Remix</a>).
가이드에 따르면, <code>routes</code> 폴더에 있는 파일을 기준으로 UI 렌더링을 위한 코드와 API 요청 처리 코드를 대략 다음과 같이 작성합니다.</p>
<ul>
<li>렌더링을 위한 UI 컴포넌트: <code>default export</code></li>
<li><code>GET</code> 요청 처리: <code>export async function loader</code></li>
<li><code>GET</code> 요청을 제외한 API 처리: <code>export async function action</code></li>
</ul>
<p>이러한 Remix 만의 API 호출 방식을 따르면서 tRPC 호출 처리를 하기 위해 다소 복잡한 구조를 가지고 있습니다.</p>
<p>공식 가이드에 따르면 tRPC client는 <code>createTRPCProxyClient</code> 함수를 사용하여 호출하도록 되어 있습니다.
하지만 Web studio는 별도의 tRPC 서버를 구성하지 않고 tRPC 요청을 Remix 프레임워크에서 받아내기 위해 <code>xxx.xxx.$method.ts</code> 형식의 라우트를 구성합니다.
그리고 이 라우트에서 tRPC 서버단 코드를 수행합니다.</p>
<p>Web studio client 에서는 Remix의 <code>action</code> 구현체 호출을 위해 <code>useFetcher</code>를 호출할 수 있는 nested proxy 객체를 생성합니다.
tRPC의 서버 route 정의로 부터 mutation을 수행하는 경우 <code>useMutation</code>을 그렇지 않은 경우 <code>useQuery</code> 호출이 가능한 proxy 객체를 만들어 냅니다.
이 proxy 객체는 route의 recode를 첫번째 key 값으로 가지고 <code>useMutation</code>을 호출할 경우 <code>POST</code>를 <code>useQuery</code> 를 호출할 경우 <code>GET</code> 요청으로 치환하여 <code>useFetcher</code>의 <code>submit</code>을 호출 합니다.</p>
<p>이 과정을 도식화하면 다음과 같습니다.</p>
<p><img alt="Alt text" loading="lazy" width="1411" height="647" decoding="async" data-nimg="1" class="shadow" style="color:transparent;width:100%;height:auto" src="/_next/static/media/project_creation.a566b71a.svg"/></p>
<p>첫 번째 <code>/dashboard</code> 요청은 <code>loader</code> 함수를 통해 필요한 데이터를 server 단에서 취합합니다.
tRPC로 정의한 <code>findMany</code>, <code>findManyByIds</code>와 같은 route를 직접 호출하며 각 route는 Prisma를 사용하여 데이터베이스를 호출하고 응답을 처리합니다.</p>
<p>사용자가 프로젝트 생성 다이얼로그의 버튼을 누르면 Remix의 <code>useFetcher</code>의 <code>submit</code>을 호출합니다.
Remix route 프레임워크에 의해 <code>dashboard.project.$method.tsx</code> 파일의 <code>loader</code> 함수를 호출하고 이는 다시 서버단의 tRPC 구현체를 호출합니다.</p>
<p>다음은 project의 모델 입니다.
생성할 때 필요한 인자는 <code>title</code> 입니다.</p>
<pre><code class="language-shell">view DashboardProject {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  title       String
  domain      String
  userId      String?
  isDeleted   Boolean  @default(false)
  isPublished Boolean
}
</code></pre>
<h1>빌더(builder)</h1>
<p><img alt="Alt text" loading="lazy" width="1720" height="928" decoding="async" data-nimg="1" class="shadow" style="color:transparent;width:100%;height:auto" src="/_next/static/media/image.4c021bbd.png"/></p>
<p>프로젝트 생성 후, 프로젝트 카드를 클릭하면 builder 화면을 표시합니다.</p>
<p>CSS grid로 레이아웃을 잡았습니다.
가운데 main 영역은 <code>&lt;iframe/&gt;</code>을 배치하였으며, side bar를 drag하여 resizing이 가능합니다.
resizing은 <code>pointerup</code>, <code>pointerdown</code>, <code>pointermove</code> 이벤트를 처리합니다. (<a href="https://github.com/swcho/webstudio/blob/a5b687b5b6c8e47ce0eb1df96e4d7157c784210f/packages/design-system/src/components/primitives/numeric-gesture-control.ts#L134">코드</a>)
resizing은 <code>canvasWidthStore</code> 값을 변경합니다.
<code>canvasWidthStore</code>값은 <code>useCanvasStyle</code> hook을 사용하여 width를 변경합니다.</p>
<p>왼쪽 navigation 영역에서 컴포넌트 추가를 할 수 있습니다.</p>
<p><img alt="Alt text" loading="lazy" width="1712" height="682" decoding="async" data-nimg="1" class="shadow" style="color:transparent;width:100%;height:auto" src="/_next/static/media/image-3.dd3c0066.png"/></p>
<p>컴포넌트 팔레트 중 하나를 드래그 하면, <code>instancesStore</code>의 값에 관련 정보를 추가 합니다.</p>
<p><code>instanceStore</code>는 immerhint가 관리하는 store이며 해당 값은 서버 동기화를 위해 <code>/rest/patch</code> 요청으로 전달합니다.</p>
<p>이렇게 immerhint에 의해 관리하는 초기화 과정 중에 설정합니다. (<a href="https://github.com/swcho/webstudio/blob/f7d7e6e88e7bb782dbc0b3ea4bccf04326aaefc4/apps/builder/app/shared/sync/sync-stores.ts#L65-L73">코드</a>)</p>
<p><code>rest.patch.ts</code>에서 이 요청을 받으면, 다음과 같은 <code>Build</code> 모델의 형식으로 Prisma를 사용해 저장하게 됩니다.</p>
<pre><code class="language-shell">model Build {
  id        String   @unique @default(uuid())
  version   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  pages     String

  project   Project @relation(fields: [projectId], references: [id])
  projectId String

  breakpoints           String @default(&quot;[]&quot;)
  styles                String @default(&quot;[]&quot;)
  styleSources          String @default(&quot;[]&quot;)
  styleSourceSelections String @default(&quot;[]&quot;)
  props                 String @default(&quot;[]&quot;)
  dataSources           String @default(&quot;[]&quot;)
  instances             String @default(&quot;[]&quot;)

  deployment    String?
  publishStatus PublishStatus @default(PENDING)

  @@id([id, projectId])
}
</code></pre>
<p>컴포넌트 팔레트에서 drag &amp; drop을 사용하여 컴포넌트를 배치하는 경우 <code>instances</code>의 정보를 업데이트 하게 됩니다.</p>
<h1>마치며</h1>
<p>프로젝트 생성과 컴포넌트 추가 과정을 살펴 보았습니다.
Remix와 tRPC의 장점을 얻기위한 구조가 인상 깊었습니다.
물론 이로인해 구현이 다소 복잡해졌지만 tRPC의 route 추가와 파라미터, 응답의 변화에 기민하게 대응하면서 remix의 구현 의도를 해치지 않도록 고민을 한 흔적이 보였습니다.</p>
<p>또한 지속적으로 변하는 drawing 정보를 데이터 베이스에 동기화 하기 위해, immerhint를 사용한 부분은 놀라웠습니다.
비교적 최신 프로젝트 답게 nanostore를 single source of truth로 사용하고 immerhint를 통해 서버와 동기화하는 부분에서 많은 아이디어를 얻었습니다.</p>
<p>다만 단일 사용자 수정이 가능한 one way 동기화 방식임으로 여러명이 협업하고 동시 편집하는 기능 구현은 시간을 두고 지켜봐야 할 것 같습니다.</p></article><div class="react-utterences"><div>Loading script...</div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blogs/2023-09-17-webstudio-part-2","query":{},"buildId":"4VfyYs9vc-5CtkULTTuNp","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>