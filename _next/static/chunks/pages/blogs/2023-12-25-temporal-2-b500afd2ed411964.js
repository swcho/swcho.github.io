(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7707],{35:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>u,meta:()=>s});var n=r(37876),i=r(91668);let l={src:"/_next/static/media/image.7eea5b38.png",height:298,width:1244,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAACCAMAAABSSm3fAAAACVBMVEUhISESFBMHBwcHR1CCAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAFElEQVR4nGNgZAADRgYQg5GRiQkAAEIACrEcJEoAAAAASUVORK5CYII=",blurWidth:8,blurHeight:2};var o=r(91013);let s={title:"Temporal Execution Platform 리뷰 #2",description:"오픈소스 Execution 플렛폼인 Temporal에 대해 소개하고 activity 동작 방삭에 대해 살펴 봅니다.",date:"2023-12-25",readTime:10},c=e=>{let{children:t}=e;return(0,n.jsx)(o.A,{meta:s,children:t})};function a(e){let t={a:"a",code:"code",h1:"h1",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{children:"Activity 동작 방식"}),"\n",(0,n.jsx)(t.p,{children:"지난 시간에 이어 확인해 보고자 하는 것은 temporal workflow 함수 내에서 수행하는 activity의 동작 방식입니다."}),"\n",(0,n.jsx)(t.p,{children:"Client 코드는 workflow 함수를 실행하지만 실제로는 worker의 workflow를 수행하는 것을 알 수 있었습니다.\n문제는 activity 인데요, activity 하나를 수행할 때마다 client와 응답을 주고 받는지가 궁금해 졌습니다.\n예상해 볼 수 있는 동작 방식은 다음과 같습니다."}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Client는 workflow 수행의 최종 결과만 받는다."}),"\n"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"Client는 workflow invocation 정보만 temporal server에 전달"}),"\n",(0,n.jsx)(t.li,{children:"temporal server는 worker에 workflow 수행 명령"}),"\n",(0,n.jsx)(t.li,{children:"worker는 해당 workflow와 activity를 모두 수행 후 최종 결과를 temporal server에 전달"}),"\n",(0,n.jsx)(t.li,{children:"temporal server는 client에 결과 전달"}),"\n",(0,n.jsx)(t.li,{children:"client 종료"}),"\n"]}),"\n",(0,n.jsxs)(t.ol,{start:"2",children:["\n",(0,n.jsx)(t.li,{children:"Client는 각 activity의 응답을 받아 다음 activity 수행여부를 결정한다."}),"\n"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"Client는 workflow invocation 정보만 temporal server에 전달"}),"\n",(0,n.jsx)(t.li,{children:"temporal server는 worker에 workflow 수행 명령"}),"\n",(0,n.jsx)(t.li,{children:"worker는 workflow 수행에 필요한 리소스 확보 후 준비되었음을 temporal server에 알림"}),"\n",(0,n.jsx)(t.li,{children:"temporal server는 client에 이를 전달"}),"\n",(0,n.jsx)(t.li,{children:"client는 activity 수행을 요청하고 결과를 받는 것을 반복"}),"\n",(0,n.jsx)(t.li,{children:"temporal server는 client에 결과 전달"}),"\n",(0,n.jsx)(t.li,{children:"client 종료"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"분석 결과 1번 방식으로 동작하고 있었습니다."}),"\n",(0,n.jsx)(t.p,{children:"따라서, client에서는 workflow invocation 정보만 전달할 뿐 실제 코드를 수행을 일체하지 않습니다.\n혹여라도 client의 코드를 바꾸어도 실행중인 worker의 코드만 수행함을 알 수 있습니다.\n다시 말해 client와 worker의 workflow 코드는 달라질 수 있습니다.\n이 경우 어떠한 방식으로 동작하는지 알고 사용을 해야 합니다."}),"\n",(0,n.jsx)(t.p,{children:"다음은 해당 결론에 이르기 까지의 분석 과정을 정리하였습니다."}),"\n",(0,n.jsx)(t.h1,{children:"Concurrently 설정"}),"\n",(0,n.jsx)(t.p,{children:"하나의 예제의 동작을 확인하려면, temporal server, worker, client를 순차적으로 실행해야 합니다."}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.a,{href:"https://www.npmjs.com/package/concurrently",children:"concurrently"}),"는 동시에 여러 명령을 수행할 수 있는 개발툴 입니다."]}),"\n",(0,n.jsx)(t.p,{children:"concurrently를 사용하여 대략 다음과 같은 명령을 수행합니다."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"concurrently --names 'server,worker,client' \\\n              -c 'blue,red,green' \\\n              'GRPC_GO_LOG_VERBOSITY_LEVEL=99 GRPC_GO_LOG_SEVERITY_LEVEL=info temporal server start-dev' \\\n              'sleep 1 && npm run worker' \\\n              'sleep 3 && GRPC_VERBOSITY=DEBUG GRPC_TRACE=all npm run client'\n"})}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"GRPC_GO_LOG_VERBOSITY_LEVEL=99 GRPC_GO_LOG_SEVERITY_LEVEL=info temporal server start-dev"})," 명령은 개발용 temporal 서버를 로컬에서 수행합니다.\nTemporal server는 go 언어로 작성한 grpc 라이브러리를 사용합니다.\n",(0,n.jsx)(t.code,{children:"GRPC_GO_LOG_VERBOSITY_LEVEL=99 GRPC_GO_LOG_SEVERITY_LEVEL=info"})," 환경변수 설정은 grpc 입출력을 파악하는데 도움이 됩니다."]}),"\n",(0,n.jsxs)(t.p,{children:["worker의 경우 rust의 GRPC 구현체인 ",(0,n.jsx)(t.a,{href:"https://github.com/hyperium/tonic",children:"tonic"}),"을 사용합니다.\n",(0,n.jsx)(t.code,{children:"tonic"})," 라이브러리는 입출력을 확인할 수 있는 로깅을 제공하지 않고 있어 temporal 구현체의 로깅을 위주로 동작 파악을 해야 합니다."]}),"\n",(0,n.jsxs)(t.p,{children:["client는 ",(0,n.jsx)(t.a,{href:"https://www.npmjs.com/package/@grpc/grpc-js",children:"@grpc/grpc-js"})," 라이브러리를 사용하고 환경 변수인 ",(0,n.jsx)(t.code,{children:"GRPC_VERBOSITY=DEBUG"}),"와 ",(0,n.jsx)(t.code,{children:"GRPC_TRACE=all"}),"는 GRPC 송수신 로그를 출력합니다."]}),"\n",(0,n.jsxs)(t.p,{children:["server, worker, client 각각 순차적으로 실행해야 함으로 ",(0,n.jsx)(t.code,{children:"sleep"})," 명령으로 시간을 조정합니다."]}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"names"})," 옵션은 각 shell 명령의 출력 prefix에 붙는 이름을 지정합니다."]}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"c"})," 옵션은 각 shell 명령의 출력 prefix의 색상을 지정합니다."]}),"\n",(0,n.jsx)(t.p,{children:"이렇게 설정하면 다음과 같은 로그를 확인할 수 있습니다."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"log",src:l})}),"\n",(0,n.jsxs)(t.p,{children:["Client는 ",(0,n.jsx)(t.code,{children:"/temporal.api.workflowservice.v1.WorkflowService/StartWorkflowExecution"})," grpc 호출을 하여 workflow 수행을 server에 요청합니다."]}),"\n",(0,n.jsx)(t.p,{children:"곧이어 worker가 동작하고 첫번째 activity는 withdraw, deposit, moneyTransfer를 순차적으로 수행합니다."}),"\n",(0,n.jsxs)(t.p,{children:["Worker의 ",(0,n.jsx)(t.code,{children:"moneyTransfer"})," activity를 수행하고 나면 client는 그 결과를 받아 transaction id와 같은 응답값을 표시합니다."]}),"\n",(0,n.jsx)(t.h1,{children:"마치며"}),"\n",(0,n.jsx)(t.p,{children:"TypeScript, Rust, Go 언어를 오가며 동작을 분석하기란 쉽지 않았습니다.\n내부 구조도 제법 복잡하여 protocol 단에서 데이터 송/수신 정보를 기반으로 분석해 보려 했습니다.\n하지만, Go의 경우 grpc 연결 설정의 로그만 나오고 Rust의 경우 로그를 남기는 방법을 찾지 못했습니다.\n다행히 node js grpc 라이브러리는 송수신 패킷 정보를 자세하게 출력하는 로그를 확인할 수 있었습니다."}),"\n",(0,n.jsx)(t.p,{children:"결국 worker에서 workflow를 수행하면서 하위 activity를 모두 수행하고 그 결과를 server에 전달하는 방식임을 확인할 수 있었습니다."}),"\n",(0,n.jsx)(t.p,{children:"생각보다 Temporal 분석에 시간이 많이 들고 지지 부진한 면이 있었습니다.\n원래 temporal의 공식 TypeScript 예제를 분석하고 마무리하려 했으나 시간이 많이 결러 고민이 됩니다.\n일단 Temporal 분석은 part 2까지 하고 다른 아이템을 찾아 리뷰해야 겠습니다."})]})}function u(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,n.jsx)(c,{...e,children:(0,n.jsx)(a,{...e})})}},3717:e=>{"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},46020:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/blogs/2023-12-25-temporal-2",function(){return r(35)}])},49034:(e,t,r)=>{"use strict";r.d(t,{A:()=>h});var n=r(18153),i=r(77328),l=r.n(i),o=r(14232);let s=o.memo(()=>(0,n.Y)(n.FK,{}));var c=r(71745),a=r(48230),u=r.n(a);let p=[{link:"/",text:"Home"}],d=o.memo(()=>{let e=(0,c.useRouter)(),[t,r]=o.useState(!1);return(0,n.FD)("nav",{className:"w-full",children:[(0,n.Y)("div",{id:"progress",className:"top-0 z-20 h-1",style:{background:"linear-gradient(to right, #4dc0b5 var(--scroll), transparent 0)"}}),(0,n.FD)("div",{className:"flex flex-wrap items-center justify-between w-full py-3 mx-auto mt-0 md:max-w-4xl",children:[(0,n.Y)("div",{className:"pl-4",children:(0,n.Y)(u(),{legacyBehavior:!0,className:"text-xl font-extrabold text-gray-900 no-underline hover:no-underline",href:"/",children:"lifetime trails"})}),(0,n.Y)("div",{className:"block pr-4 lg:hidden",children:(0,n.Y)("button",{id:"nav-toggle",type:"button",className:"flex items-center px-3 py-2 text-gray-500 appearance-none hover:text-gray-900 hover:border-teal-500 focus:outline-none",onMouseDown:e=>e.preventDefault(),onClick:()=>r(!t),onBlur:()=>r(!1),children:(0,n.FD)("svg",{className:"w-3 h-3 fill-current",viewBox:"0 0 20 20",xmlns:"http://www.w3.org/2000/svg",children:[(0,n.Y)("title",{children:"Menu"}),(0,n.Y)("path",{d:"M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"})]})})}),(0,n.Y)("div",{id:"nav-content",className:"bg-gray-100 border-b flex-grow lg:border-none lg:flex lg:items-center lg:mt-0 lg:shadow-none lg:w-auto md:bg-transparent mt-2 shadow w-full z-20 ".concat(t?"block":"hidden"),children:(0,n.Y)("ul",{className:"items-center justify-end flex-1 list-reset lg:flex",children:p.map(t=>{let{link:r,text:i}=t;return(0,n.Y)("li",{className:"mr-3",children:(0,n.Y)(u(),{legacyBehavior:!0,className:e.pathname===r?"inline-block py-2 px-4 text-gray-900 font-bold no-underline":"inline-block text-gray-600 no-underline hover:text-gray-900 hover:text-underline py-2 px-4",href:r,children:i})},r)})})})]})]})}),h=o.memo(e=>{let{children:t,title:r="This is the default title"}=e;return(0,n.FD)("div",{className:"leading-normal tracking-normal bg-gray-100 min-h-screen",children:[(0,n.FD)(l(),{children:[(0,n.Y)("title",{children:r}),(0,n.Y)("meta",{charSet:"utf-8"}),(0,n.Y)("meta",{name:"viewport",content:"initial-scale=1.0, width=device-width"})]}),(0,n.Y)(d,{}),(0,n.Y)("div",{className:"container w-full px-4 pb-10 mx-auto md:max-w-3xl",children:t}),(0,n.Y)(s,{})]})})},56486:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.identifierTypes=void 0;var n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e){for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}}return t.default=e,t}(r(14232)),i=function(e){return e&&e.__esModule?e:{default:e}}(r(95062));function l(e){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=["pathname","url","title","og:title","issue-number","issue-term"],a=function(e,t,r){if(0>c.indexOf(e))return void console.warn("Wrong type: "+e);if("pathname"===e)return"pathname";if("url"===e)return"url";if("title"===e)return"title";if("og:title"===e)return"og:title";if("issue-term"===e)return t;else if("issue-number"===e)return r},u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,i;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return(t=(i=o(r).call(this,e))&&("object"===l(i)||"function"==typeof i)?i:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this)).myRef=n.default.createRef(),t.state={pending:!0},t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&s(r,e),t=[{key:"componentDidMount",value:function(){var e=this,t=this.props,r=t.repo,n=t.type,i=t.specificTerm,l=t.issueNumber,o=0>c.indexOf(n)?void console.warn("Wrong type: "+n):"issue-number"===n?"issue-number":"issue-term",s=a(n,i,l);if("issue-term"===n&&!s)return void console.warn("When type is '".concat(n,"', 'specificTerm' prop must be provided"));if("issue-number"===n&&(isNaN(s)||s<1))return void console.warn("When type is '".concat(n,"', valid 'issueNumber' prop must be provided"));var u=document.createElement("script");u.src="https://utteranc.es/client.js",u.async=!0,u.setAttribute("repo",r),u.setAttribute("crossorigin","anonymous"),u.setAttribute(o,s),u.onload=function(){return e.setState({pending:!1})},this.myRef.current.appendChild(u)}},{key:"render",value:function(){return n.default.createElement("div",{className:"react-utterences",ref:this.myRef},this.props.debug&&n.default.createElement("pre",{style:{background:"#cccccc",padding:10}},"\nthis.props: ".concat(JSON.stringify(this.props,null,2),'\nlocation.pathname: "').concat(window.location.pathname,'"\nlocation.href: "').concat(window.location.href,'"\n          ').trim()),this.props.debug&&n.default.createElement("div",null,"\uD83D\uDC47\uD83D\uDC47If the settings are valid, the comment widget appear below\uD83D\uDC47\uD83D\uDC47"),this.state.pending&&n.default.createElement("div",null,"Loading script..."))}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(r.prototype,t),r}(n.Component);t.identifierTypes={pathname:{attrValue:"",summary:"Issue title contains page pathname"},url:{attrValue:"url",summary:"Issue title contains page URL"},title:{attrValue:"title",summary:"Issue title contains page title"},"og:title":{attrValue:"og:title",summary:"Issue title contains page og:title"},"issue-number":{attrValue:-1,summary:"Specific issue number"},"issue-term":{attrValue:"",summary:"Issue title contains specific term"}},u.propTypes={type:i.default.string.isRequired,repo:i.default.string.isRequired,specificTerm:i.default.string,issueNumber:i.default.number,hashKey:i.default.string,debug:i.default.bool},t.default=u},60158:(e,t,r)=>{"use strict";r.d(t,{J:()=>s,j:()=>o});var n=r(18153),i=r(14232);let l=i.createContext({});function o(e){let{staticProps:t,children:r}=e;return(0,n.Y)(l.Provider,{value:t,children:r})}function s(){return i.useContext(l)}},79706:(e,t,r)=>{"use strict";var n=r(3717);function i(){}function l(){}l.resetWarningCache=i,e.exports=function(){function e(e,t,r,i,l,o){if(o!==n){var s=Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw s.name="Invariant Violation",s}}function t(){return e}e.isRequired=e;var r={array:e,bigint:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:l,resetWarningCache:i};return r.PropTypes=r,r}},85419:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var n=r(18153);r(14232);let i=e=>{let{meta:t,isBlogPost:r}=e;return(0,n.FD)(n.FK,{children:[(0,n.Y)("h1",{className:"font-bold text-gray-800 mb-4 ".concat(r?"text-5xl mt-8 mb-8":"text-lg"),children:t.title}),(0,n.FD)("div",{className:"details",children:[(0,n.Y)("p",{className:"text-gray-500",children:t.description}),(0,n.Y)("p",{className:"text-gray-400 text-right -mt-1",children:(0,n.Y)("span",{className:"mr-4",children:t.date})})]})]})}},86089:(e,t,r)=>{"use strict";Object.defineProperty(t,"Ay",{enumerable:!0,get:function(){return n.default}});var n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e){for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}}return t.default=e,t}(r(56486))},91013:(e,t,r)=>{"use strict";r.d(t,{A:()=>p});var n=r(18153),i=r(73146),l=r.n(i),o=r(14232),s=r(86089),c=r(60158),a=r(85419),u=r(49034);function p(e){let{children:t,meta:r,staticProps:i}=e;return o.useEffect(()=>{l().highlightAll()},[]),(0,n.Y)(n.FK,{children:(0,n.FD)(u.A,{title:r.title,children:[(0,n.Y)(a.A,{meta:r,isBlogPost:!0}),(0,n.Y)(c.j,{staticProps:i,children:(0,n.Y)("article",{className:"markdown",children:t})}),(0,n.Y)(s.Ay,{repo:"swcho/blog-comments",type:"pathname",label:"utterances",theme:"github-light"})]})})}},95062:(e,t,r)=>{e.exports=r(79706)()}},e=>{e.O(0,[5695,636,6593,8792],()=>e(e.s=46020)),_N_E=e.O()}]);
//# sourceMappingURL=2023-12-25-temporal-2-b500afd2ed411964.js.map