<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="initial-scale=1.0, width=device-width" data-next-head=""/><title data-next-head="">Web studio part 3</title><link rel="preload" href="/_next/static/css/d20c50ed748cd26f.css" as="style"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/vs2015.min.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous"/><link rel="stylesheet" href="/_next/static/css/d20c50ed748cd26f.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-b9bde0f71dfd7f80.js" defer=""></script><script src="/_next/static/chunks/framework-e837885f9f00810f.js" defer=""></script><script src="/_next/static/chunks/main-beade485850481f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-57b73c2138884752.js" defer=""></script><script src="/_next/static/chunks/5695-9c01eff236121af5.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/2023-09-24-webstudio-part-3-0bc68a3bd66b9380.js" defer=""></script><script src="/_next/static/4VfyYs9vc-5CtkULTTuNp/_buildManifest.js" defer=""></script><script src="/_next/static/4VfyYs9vc-5CtkULTTuNp/_ssgManifest.js" defer=""></script><style id="__jsx-4134105190">.markdown html{font:118.75%/1.58 'Roboto',serif;box-sizing:border-box;overflow-y:scroll;}.markdown *{box-sizing:inherit;}.markdown *:before{box-sizing:inherit;}.markdown *:after{box-sizing:inherit;}.markdown body{color:hsla(0,0%,0%,0.73);font-family:'Roboto',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}.markdown img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}.markdown h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}.markdown h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}.markdown h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}.markdown h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}.markdown h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Roboto Slab',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}.markdown hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown ul{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}.markdown ol{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}.markdown dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.85rem;line-height:1.58rem;}.markdown table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:1rem;line-height:1.58rem;border-collapse:collapse;width:100%;}.markdown fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.94737rem;line-height:1.58rem;border-left:0.5925rem solid #017698;color:hsla(0,0%,0%,0.65);background-color:hsla(0,0%,0%,0.1);padding:0.29625rem 0.9875rem;font-style:italic;}.markdown form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.58rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}.markdown address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}.markdown b{font-weight:700;}.markdown strong{font-weight:700;}.markdown dt{font-weight:700;}.markdown th{font-weight:700;}.markdown li{margin-bottom:calc(1.58rem / 2);}.markdown ol li{padding-left:0;}.markdown ul li{padding-left:0;}.markdown li > ol{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}.markdown li > ul{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}.markdown blockquote *:last-child{margin-bottom:0;}.markdown li *:last-child{margin-bottom:0;}.markdown p *:last-child{margin-bottom:0;}.markdown li > p{margin-bottom:calc(1.58rem / 2);}.markdown code{font-size:0.85rem;line-height:1.58rem;}.markdown kbd{font-size:0.85rem;line-height:1.58rem;}.markdown samp{font-size:0.85rem;line-height:1.58rem;}.markdown abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}.markdown acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}.markdown abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}.markdown thead{text-align:left;}.markdown td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.05333rem;padding-right:1.05333rem;padding-top:0.79rem;padding-bottom:calc(0.79rem - 1px);}.markdown th:first-child,td:first-child{padding-left:0;}.markdown th:last-child,td:last-child{padding-right:0;}.markdown a{color:#017698;text-decoration:none;background-image:linear-gradient(to top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0) 1px, #017698 1px, #017698 2px, rgba(0, 0, 0, 0) 2px);}.markdown a:hover,a:active{text-shadow:none;background-image:none;}.markdown h1,h2,h3,h4,h5,h6{margin-top:3.16rem;}.markdown li>ol,li>ul{margin-left:20px;margin-bottom:0;}.markdown blockquote > :last-child{margin-bottom:0;}.markdown blockquote cite{font-size:1rem;line-height:1.58rem;color:hsla(0,0%,0%,0.73);font-style:normal;font-weight:400;}.markdown blockquote cite:before{content:"— ";}.markdown @media only screen and (max-width:480px){html{font-size:106.25%;line-height:28px;}blockquote{border-left:0.29625rem solid #017698;color:hsla(0,0%,0%,0.59);padding-left:0.88875rem;font-style:italic;margin-left:-1.185rem;margin-right:0;}} .markdown{color:#3d3d3d}.markdown ul li{list-style-type:disc}.markdown ol{list-style-type:decimal}:not(pre) code{background-color:rgb(203 208 218);border-radius:3px;font-family:D2Coding,Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:.2rem .3rem;margin:0 .2rem}.markdown * code{font-size:inherit}.markdown code[class*="language-"]{font-family:D2Coding,Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:1rem;background-color:#2d2d2d}</style></head><body><div id="__next"><div class="leading-normal tracking-normal bg-gray-100 min-h-screen"><nav class="w-full"><div id="progress" class="top-0 z-20 h-1" style="background:linear-gradient(to right, #4dc0b5 var(--scroll), transparent 0)"></div><div class="flex flex-wrap items-center justify-between w-full py-3 mx-auto mt-0 md:max-w-4xl"><div class="pl-4"><a href="/">lifetime trails</a></div><div class="block pr-4 lg:hidden"><button id="nav-toggle" type="button" class="flex items-center px-3 py-2 text-gray-500 appearance-none hover:text-gray-900 hover:border-teal-500 focus:outline-none"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button></div><div id="nav-content" class="bg-gray-100 border-b flex-grow lg:border-none lg:flex lg:items-center lg:mt-0 lg:shadow-none lg:w-auto md:bg-transparent mt-2 shadow w-full z-20 hidden"><ul class="items-center justify-end flex-1 list-reset lg:flex"><li class="mr-3"><a href="/">Home</a></li></ul></div></div></nav><div class="container w-full px-4 pb-10 mx-auto md:max-w-3xl"><h1 class="font-bold text-gray-800 mb-4 text-5xl mt-8 mb-8">Web studio part 3</h1><div class="details"><p class="text-gray-500">Web studio의 작성 기능을 구조적으로 살펴 봅니다.</p><p class="text-gray-400 text-right -mt-1"><span class="mr-4">2023-09-24</span></p></div><article class="markdown"><h1>Tech stack</h1>
<h2><a href="https://lexical.dev/">Lexical</a></h2>
<p>Meta(Facebook)에서 만든 오픈소스 텍스트 에디터 입니다.
React 기반으로 확장이 용이한 구조로 되어 있습니다.
Plugin 방식의 확장을 위해 별도의 구조를 잡지 않고 React의 context를 사용하여 child node에서 plugin 컴포넌트를 추가하는 방식을 사용하고 있습니다.</p>
<h1>builder &amp; canvas</h1>
<p>Builder는 canvas 영역을 포함하는 전체 작성 화면을 말합니다.</p>
<p>canvas는 Iframe으로 되어 있기 때문에 root window와 iframe window 사이에 데이터 동기화가 필요합니다.</p>
<p>가령 Builder의 Navigator 영역에서 컴포넌트를 재배치하면 canvas 영역에서도 컴포넌트 재배치가 이루어져야 합니다.
그리고 그 반대의 동작도 가능해야 합니다.</p>
<p>이러한 기능을 구현한 것이 <code>pubsub</code> 입니다.</p>
<p><code>pubsub</code>의 설정은 각각 <code>useBuildStore</code>, <code>useCanvasStore</code>에서 합니다.</p>
<p><code>immerhin</code>은 이 builder와 canvas의 동기화 과정에서도 store의 변경에따라 publish 하고 이를 subscribe하는 측에서 다시 store 업데이트를 하는데 사용합니다.</p>
<h1>Component tree 생성</h1>
<p><code>@webstudio-is/react-sdk</code> 패키지는 <code>ReactSdkContext</code>를 통해 렌더링 정보를 공유 합니다.</p>
<p>컴포넌트 트리의 엘리먼트는 <code>Instance</code>라고 합니다.</p>
<pre><code class="language-ts">export const Instance = z.object({
  type: z.literal(&#x27;instance&#x27;),
  id: InstanceId,
  component: z.string(),
  label: z.string().optional(),
  children: z.array(z.union([Id, Text])),
});
</code></pre>
<p><code>component</code>는 해당 <code>Instance</code>가 어떠한 컴포넌트인지 <code>children</code>은 인스턴스는 그 자식들을 가리킵니다.</p>
<p>다음은 <code>Instance</code> map을 구성하는 예시 입니다.</p>
<pre><code class="language-ts">const instances = new Map([
  createInstancePair(&#x27;root&#x27;, &#x27;Body&#x27;, [{ type: &#x27;id&#x27;, value: &#x27;box1&#x27; }]),
  createInstancePair(&#x27;box1&#x27;, &#x27;Box&#x27;, [
    { type: &#x27;id&#x27;, value: &#x27;box11&#x27; },
    { type: &#x27;id&#x27;, value: &#x27;box12&#x27; },
    { type: &#x27;id&#x27;, value: &#x27;box13&#x27; },
  ]),
  createInstancePair(&#x27;box11&#x27;, &#x27;Box&#x27;, []),
  createInstancePair(&#x27;box12&#x27;, &#x27;Box&#x27;, []),
  createInstancePair(&#x27;box13&#x27;, &#x27;Box&#x27;, []),
]);
</code></pre>
<p><code>createElementsTree</code>는 <code>Instance</code> map 정보를 받아 <code>ReactSdkContext</code>를 구성하고 <code>Provider</code>를 제공합니다.</p>
<p><code>Instance</code>는 <code>WebstudioComponent</code>에 의해 최종 렌더링 합니다.</p>
<p><code>WebstudioComponent</code>는 high order component로서 <code>Instance</code>가 가리키는 React 컴포넌트를 생성하고, 필요한 props 정보를 반환합니다.</p>
<pre><code class="language-ts">export const WebstudioComponent = forwardRef&lt;HTMLElement, WebstudioComponentProps&gt;(
  ({ instance, instanceSelector, children, components, ...rest }, ref) =&gt; {
    const { [showAttribute]: show = true, ...instanceProps } = useInstanceProps(instance.id);
    const props = {
      ...instanceProps,
      ...rest,
      [idAttribute]: instance.id,
      [componentAttribute]: instance.component,
    };
    if (show === false) {
      return &lt;&gt;&lt;/&gt;;
    }
    const Component = components.get(instance.component);
    if (Component === undefined) {
      return &lt;&gt;&lt;/&gt;;
    }
    return (
      &lt;Component {...props} ref={ref}&gt;
        {renderWebstudioComponentChildren(children)}
      &lt;/Component&gt;
    );
  }
);
</code></pre>
<p><code>createElementsTree</code>에서 <code>Component</code> prop을 통해 <code>WebstudioComponent</code>를 전달하면 최종 결과물을 렌더링 합니다.</p>
<p>Builder의 canvas에서는 <code>createElementsTree</code>의 <code>Component</code> prop에 <code>WebstudioComponentPreview</code> 또는 <code>WebstudioComponentCanvas</code>를 대입합니다.</p>
<p>먼저 <code>WebstudioComponentPreview</code>를 살펴 보면 <code>Instance</code> 별 style과 관련된 내용을 추가로 적용하는 코드가 전부 입니다.</p>
<pre><code class="language-ts">export const WebstudioComponentPreview = forwardRef&lt;HTMLElement, WebstudioComponentProps&gt;(
  ({ instance, instanceSelector, children, components, ...restProps }, ref) =&gt; {
    const instanceStyles = useInstanceStyles(instance.id);
    useCssRules({ instanceId: instance.id, instanceStyles });
    const { [showAttribute]: show = true, ...instanceProps } = useInstanceProps(instance.id);
    const props = {
      ...mergeProps(restProps, instanceProps, &#x27;merge&#x27;),
      [idAttribute]: instance.id,
      [componentAttribute]: instance.component,
    };
    if (show === false) {
      return &lt;&gt;&lt;/&gt;;
    }
    const Component = components.get(instance.component);
    if (Component === undefined) {
      return &lt;&gt;&lt;/&gt;;
    }
    return (
      &lt;Component {...props} ref={ref}&gt;
        {renderWebstudioComponentChildren(children)}
      &lt;/Component&gt;
    );
  }
);
</code></pre>
<p>반면 <code>WebstudioComponentCanvas</code>의 구현은 <code>WebstudioComponentPreview</code>의 기능과 더불어 <code>&lt;TextEditor/&gt;</code> 컴포넌트의 <a href="https://lexical.dev/">Lexical</a> 에디터를 확장한 wysiwyg editing 기능이 있습니다.</p>
<h1>마치며</h1>
<p>Web studio의 구조를 중심으로 살펴 보았습니다.</p>
<p>먼저 iframe으로 나누어진 canvas 영역으로 인해 <code>pubsub</code>즉 <code>postMessage</code>를 사용한 프로토콜 사용이 불가피 했습니다.
물론 <code>imerhin</code>을 사용하여 store 동기화를 서버와 하듯이 iframe간에 동기화에도 사용하고 있지만 궁극적으로 <code>postMessage</code>를 사용한 별도의 프로토콜 레이어의 구현과 운용은 불필요한 복잡도를 가져다 준 것은 아닌가 생각합니다.</p>
<p>이러한 복잡도에 비해 얻어지는 뚜련한 장점은 찾을 수 없었습니다.</p>
<p>Remix의 사용도 과한 측면이 보입니다.
SSR이 구지 필요한가 싶은 애플리케이션이기 때문입니다.
사용자 생셩형 컨텐츠의 경우 빠른 렌더링과 SEO등을 위해 SSR이 필요하지만 Web studio는 CSR로 충분하다고 생각합니다.
tRPC를 사용하면서 Remix와 연동하는 부분도 인상 깊었지만 뚜렷한 장점을 찾을 수 없었습니다.</p>
<p>하지만 웹저작툴의 기본적인 구조와 설계시 고려사항을 고민해볼 수 있어 좋았습니다.
앞으로도 꾸준히 발전하기를 응원해 봅니다.</p></article><div class="react-utterences"><div>Loading script...</div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blogs/2023-09-24-webstudio-part-3","query":{},"buildId":"4VfyYs9vc-5CtkULTTuNp","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>